<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>My A++ Interpreter</title>
    <script>
    function tokenize(input) {
      const tokens = [];
      let currentToken = '';

      // Looping through all the chars
      for (let i = 0; i < input.length; i++) {
        const char = input[i];

        // Pushing the token once space is reached
        if (char === ' ' || char === '\t') {
          if (currentToken.length > 0) {
            tokens.push(currentToken);
            currentToken = '';
          }
        } else if (char === '\n') {

          // IM A SIGMA SO THERE IS NO ; YESSS

          if (currentToken.length > 0) {
            tokens.push(currentToken);
            currentToken = '';
          }
          tokens.push('\n');
        } else if (char === '+') {
          tokens.push(currentToken);
          console.log(`The value is ${currentToken}`);
          tokens.push(char);
          currentToken = '';
        }
        else {
          currentToken += char;
        }
      }

      if (currentToken.length > 0) {
        tokens.push(currentToken);
      }

      return tokens;
    }

    function parse(tokens) {
      console.log(tokens);
      const tree = {
        type: "main",
        content: []
      };
      let id = 0;
      while (id < tokens.length) {
        const reserved = ['set', 'to', 'out', 'change', '\n', "+"]

        console.log("WHILE LOOP IS WORKING!!");
        console.log(tokens[id]);
        token = tokens[id];

        let outputNode = {};
        switch (token) {
          case "out":
            outputNode = {
              type: "print",
              value: null
            }
            id++;
            if (tokens[id] != "\n") {
              if (isString(tokens[id])) {
                outputNode.value = {
                  type: "string",
                  value: tokens[id].slice(1, -1),
                };
              } else {
                outputNode.value = {
                  type: "identifier",
                  name: tokens[id]
                };
              }
            }
            console.log("OMG IT WORKS");
            tree.content.push(outputNode);
            id++;
            break;


          case "set":
            id++;

            outputNode = {
              type: "assignment",
              identifier: null,
              value: null
            };

            if (tokens[id] in reserved) {
              throw new Error("Syntax Error: Variable identifier cannot be a reserved keyword");
              break;
            }

            if (isString(tokens[id])) {
              throw new Error("Syntax Error: Variable identifier cannot be a string");
              break;
            }

            outputNode.identifier = tokens[id];

            id++;

            if (tokens[id] != 'to') {
              throw new Error("Syntax Error: Keyword \"to\" must be used for assignment");
              break;
            }

            id++;

            const assignedValue = {
              type: "string",
              value: tokens[id],
            };

            if (isString(tokens[id])) {
              assignedValue.type = 'string';
            } else {
              assignedValue.type = 'number';
            }
            outputNode.value = assignedValue;
            tree.content.push(outputNode);
            id++;

            break;

          case '\n':
            id++;
            break;
         
          case '+':
            outputNode = {
              type: 'addition',
              val1: null,
              val2: null
            }
            // Concatenation
            if (isString(tokens[id-1])) {
              outputNode.val1 = {
                type: "string",
                value: tokens[id-1].slice(1, -1)
              }
             
            }
            // Addition
            else if (isNumeric(outputNode.val1)) {
              outputNode.val1 = {
                type: "number",
                value: tokens[id-1]
              }
            }
            else {
              outputNode.val1 = {
                type: "identifier",
                name: tokens[id-1]
              }
            }

            // Concatenation
            if (isString(tokens[id-1])) {
              outputNode.val1 = {
                type: "string",
                value: tokens[id+1].slice(1, -1)
              }
             
            }
            // Addition
            else if (isNumeric(outputNode.val1)) {
              outputNode.val1 = {
                type: "number",
                value: tokens[id+1]
              }
            }

            else {
              outputNode.val1 = {
                type: "identifier",
                name: tokens[id+1]
              }
            }
            id += 2;
            break;
          default:
             id++;

        }
      }
      return tree;
    }

   
    function isNumeric(n) { return !isNaN(parseFloat(n)) && isFinite(n); }

    function isString(value){
      return (value.startsWith('"') && value.endsWith('"'))
    }

    const environment = {};

    function interpret(node) {
      switch (node['type']) {
        case "main":
          node.content.forEach(interpret);
          break;
        case "print":
          const value = interpret(node.value);
          document.getElementById("output").innerHTML += value + '<br>';
          return value;
        case "assignment":
          console.log(`The Variable ${node.identifier} is being assigned`);
          environment[node.identifier] = interpret(node.value);
          console.log(`The value is now set to ${environment[node.identifier]}`);
          return;
        case "string":
          return node.value;
        case "identifier":
          if (typeof environment[node.name] === 'undefined') {
            throw new Error(`Name Error: Variable ${node.name} is undefined`);
            return;
          } else {
            if (isString(environment[node.name])) {
              return environment[node.name].slice(1, -1);
            } else {
              return environment[node.name].slice(1, -1);
            }
          }
        case "number":
          return node.value;
        case "addition":
          return (interpret(node.val1) + interpret(node.val2));
        default:
          throw new Error(`Unknown node type: ${node.type}`);
      }
    }

    function run() {
      const input = document.getElementById("coders").value;
      const tokens = tokenize(input);
      let ast = parse(tokens);
      console.log(JSON.stringify(ast, null, 2)); // Log the AST
      interpret(ast);
    }
    </script>
  </head>
  <body>
    <form>
      <textarea id='coders'></textarea>
    </form>
    <button onclick="run()">RUN MY GOD DAMN CODE</button>
    <p id='output'>Welcome to A++, a language designed to be as close to english as possible!<br><br></p>
  </body>
</html>

